import{I as ve}from"./chunk-QJ6SBVJ2--_dH3EVW.js";import{R as He,O as Fe,C as Le}from"./chunk-P3DRE4IY-BI869rb7.js";import{M as ye}from"./chunk-NNBHHXXN-1OCOJUJo.js";import{c as ze,d as Be,e as Ve,u as Ue,f as Ge,g as $e,h as Xe,i as Qe,j as Je,k as Ke,l as We,m as Ye,n as Ze,o as et,p as tt,q as nt}from"./chunk-WJF5PDPA-xZXAPsJb.js";import{g as Ie,D as st}from"./chunk-PXZ7QYKX-D00G5ClL.js";import{c as it,o as at}from"./chunk-GUHHFSZA-DUcxoFZM.js";import{D as ot}from"./chunk-HTSFT44S-CJUe0A-W.js";import{a as K}from"./chunk-PDWBYQOW-Dmlh1vBq.js";import{P as Ne,a as Se}from"./chunk-IQBAUTU5-DH-5p8fh.js";import{R as rt,u as lt,b as V,aT as dt,aU as ct,r as v,j as e,t as D,a8 as ut,H as ue,y as te,v as g,aa as mt,B as W,ab as pt,cY as ht,w as Ee,T as G,s as Ce,d0 as ft,aB as Pe,I as ce,A as Me,X as me,d1 as xt,ac as q}from"./index-CfFT3zi1.js";import{u as ke,_ as Ae}from"./chunk-B2JT2FOA-BnFeTz6O.js";import"./lodash-PKdnE55o.js";import{C as ne}from"./chunk-GZBFGV7Y-Se72An9a.js";import{c as pe}from"./chunk-MWVM4TYO-bKUcYSnf.js";import"./chunk-GJUPECDU-CyxQpaI_.js";import{u as we}from"./chunk-C76H5USB-BIVYLwoc.js";import{K as gt}from"./chunk-6HTZNHPT-BcSjToUL.js";import{R as X,u as _t,a as De,S as U}from"./chunk-4TC5YS65-Um6ptYuI.js";import{u as Te}from"./chunk-GRT22PE5-B7z3lCPT.js";import{u as bt}from"./use-prompt-DtSGXkLQ.js";import{P as he}from"./pencil-square-CdAEnNJs.js";import{X as Re}from"./x-circle-JwhTJJtO.js";import{C as fe}from"./currency-input-BRRQzzSW.js";import{A as qe}from"./alert-DcMcEDC4.js";import{c as Oe}from"./index-DbWNSxG7.js";import{C as se}from"./checkbox-CSznYXif.js";import"./Trans-9Tf8C9WY.js";import"./chunk-P3UUX2T6-CxuPTWLZ.js";import"./chunk-YEDAFXMB-DWDp3rGV.js";import"./chunk-AOFGTNG6-CnozerN3.js";import"./table-1Pop49eK.js";import"./chunk-EMIHDNB7-sq3Rkcfo.js";import"./plus-mini-BHgsEJRM.js";import"./command-bar-CnueQ5Ud.js";import"./index-DSzuN2X_.js";import"./x-mark-mini-MvZodUZ3.js";import"./triangles-mini-C3n3c70C.js";import"./chunk-PFKKVLZX-DXwkveKp.js";import"./format-CD0QRNoV.js";import"./_isIndex-CZQ9OX9_.js";import"./index-B-oTeFUj.js";import"./date-picker-OUZSlUXd.js";import"./clsx-B-dksMZM.js";import"./popover-Jap1wZaP.js";import"./triangle-left-mini-Cqpo5cQq.js";import"./prompt-hJIgjWBE.js";import"./index.esm-DbViPNyb.js";var jt=q.object({inbound_items:q.array(q.object({item_id:q.string(),quantity:q.number(),reason_id:q.string().nullish(),note:q.string().nullish()})),outbound_items:q.array(q.object({item_id:q.string(),quantity:q.number()})),location_id:q.string().optional(),inbound_option_id:q.string().nullish(),outbound_option_id:q.string().nullish(),send_notification:q.boolean().optional()}),J=Oe(),vt=s=>{const{t:r}=V();return v.useMemo(()=>[J.display({id:"select",header:({table:o})=>e.jsx(se,{checked:o.getIsSomePageRowsSelected()?"indeterminate":o.getIsAllPageRowsSelected(),onCheckedChange:l=>o.toggleAllPageRowsSelected(!!l)}),cell:({row:o})=>{const l=o.getCanSelect();return e.jsx(se,{disabled:!l,checked:o.getIsSelected(),onCheckedChange:a=>o.toggleSelected(!!a),onClick:a=>{a.stopPropagation()}})}}),J.display({id:"product",header:()=>e.jsx(Se,{}),cell:({row:o})=>e.jsx(Ne,{product:{thumbnail:o.original.thumbnail,title:o.original.product_title}})}),J.accessor("variant.sku",{header:r("fields.sku"),cell:({getValue:o})=>o()||"-"}),J.accessor("variant.title",{header:r("fields.variant")}),J.accessor("quantity",{header:()=>e.jsx("div",{className:"flex size-full items-center overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:r("fields.quantity")})}),cell:({getValue:o,row:l})=>Ie(l.original)}),J.accessor("refundable_total",{header:()=>e.jsx("div",{className:"flex size-full items-center justify-end overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:r("fields.price")})}),cell:({getValue:o})=>{const l=o()||0,a=K(l,s);return e.jsx("div",{className:"flex size-full items-center justify-end overflow-hidden text-right",children:e.jsx("span",{className:"truncate",children:a})})}})],[r,s])},yt=()=>{const{t:s}=V();return[{key:"created_at",label:s("fields.createdAt"),type:"date"},{key:"updated_at",label:s("fields.updatedAt"),type:"date"}]},It=({pageSize:s=50,prefix:r})=>{const o=we(["q","offset","order","created_at","updated_at"],r),{offset:l,created_at:a,updated_at:p,...x}=o;return{searchParams:{...x,limit:s,offset:l?Number(l):0,created_at:a?JSON.parse(a):void 0,updated_at:p?JSON.parse(p):void 0},raw:o}},ie=50,xe="rit",Nt=({onSelectionChange:s,selectedItems:r,items:o,currencyCode:l})=>{const{t:a}=V(),[p,x]=v.useState(r.reduce((b,j)=>(b[j]=!0,b),{})),S=b=>{const j=typeof b=="function"?b(p):b;x(j),s(Object.keys(j))},{searchParams:I,raw:E}=It({pageSize:ie,prefix:xe}),M=v.useMemo(()=>{const{order:b,offset:j,limit:O,q:C,created_at:H,updated_at:$}=I;let R=o;if(C&&(R=R.filter(F=>{var P;return F.product_title.toLowerCase().includes(C.toLowerCase())||F.variant_title.toLowerCase().includes(C.toLowerCase())||((P=F.variant_sku)==null?void 0:P.toLowerCase().includes(C.toLowerCase()))})),b){const F=b[0]==="-"?"desc":"asc",P=b.replace("-","");R=St(R,P,F)}return H&&(R=ge(R,H,"created_at")),$&&(R=ge(R,$,"updated_at")),R.slice(j,j+O)},[o,l,I]),A=vt(l),T=yt(),{table:w}=ke({data:M,columns:A,count:M.length,enablePagination:!0,getRowId:b=>b.id,pageSize:ie,enableRowSelection:b=>Ie(b.original)>0,rowSelection:{state:p,updater:S}});return e.jsx("div",{className:"flex size-full flex-col overflow-hidden",children:e.jsx(Ae,{table:w,columns:A,pageSize:ie,count:M.length,filters:T,pagination:!0,layout:"fill",search:!0,orderBy:[{key:"product_title",label:a("fields.product")},{key:"variant_title",label:a("fields.variant")},{key:"sku",label:a("fields.sku")}],prefix:xe,queryObject:E})})},St=(s,r,o)=>s.sort((l,a)=>{let p,x;return r==="product_title"?(p=l.product_title,x=a.product_title):r==="variant_title"?(p=l.variant_title,x=a.variant_title):r==="sku"&&(p=l.variant_sku,x=a.variant_sku),p<x?o==="asc"?-1:1:p>x?o==="asc"?1:-1:0}),ge=(s,r,o)=>{const{gt:l,gte:a,lt:p,lte:x}=r;return s.filter(S=>{const I=new Date(S[o]);let E=!0;return l&&(E=E&&I>new Date(l)),a&&(E=E&&I>=new Date(a)),p&&(E=E&&I<new Date(p)),x&&(E=E&&I<=new Date(x)),E})};function Et({item:s,previewItem:r,currencyCode:o,form:l,onRemove:a,onUpdate:p,index:x}){const{t:S}=V(),{return_reasons:I=[]}=ft({fields:"+label"}),E=l.watch(`inbound_items.${x}`),M=typeof E.reason_id=="string",A=typeof E.note=="string";return e.jsxs("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:[e.jsxs("div",{className:"flex flex-col items-center gap-x-2 gap-y-2 p-3 text-sm md:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(Pe,{src:s.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsxs(G,{className:"txt-small",as:"span",weight:"plus",children:[s.title," "]}),s.variant_sku&&e.jsxs("span",{children:["(",s.variant_sku,")"]})]}),e.jsx(G,{as:"div",className:"text-ui-fg-subtle txt-small",children:s.product_title})]})]}),e.jsxs("div",{className:"flex flex-1 justify-between",children:[e.jsxs("div",{className:"flex flex-grow items-center gap-2",children:[e.jsx(g.Field,{control:l.control,name:`inbound_items.${x}.quantity`,render:({field:T})=>e.jsxs(g.Item,{children:[e.jsx(g.Control,{children:e.jsx(ce,{...T,className:"bg-ui-bg-base txt-small w-[67px] rounded-lg",min:1,max:s.quantity,type:"number",onBlur:w=>{const b=w.target.value,j=b===""?null:Number(b);T.onChange(j),j&&p({quantity:j})}})}),e.jsx(g.ErrorMessage,{})]})}),e.jsx(G,{className:"txt-small text-ui-fg-subtle",children:S("fields.qty")})]}),e.jsx("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0",children:e.jsx(ye,{currencyCode:o,amount:r.return_requested_total})}),e.jsx(Me,{groups:[{actions:[!M&&{label:S("actions.addReason"),onClick:()=>l.setValue(`inbound_items.${x}.reason_id`,""),icon:e.jsx(Le,{})},!A&&{label:S("actions.addNote"),onClick:()=>l.setValue(`inbound_items.${x}.note`,""),icon:e.jsx(st,{})},{label:S("actions.remove"),onClick:a,icon:e.jsx(Re,{})}].filter(Boolean)}]})]})]}),e.jsxs(e.Fragment,{children:[M&&e.jsxs("div",{className:"grid grid-cols-1 gap-2 p-3 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(g.Label,{children:S("orders.returns.reason")}),e.jsx(g.Hint,{className:"!mt-1",children:S("orders.returns.reasonHint")})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(g.Field,{control:l.control,name:`inbound_items.${x}.reason_id`,render:({field:{ref:T,value:w,onChange:b,...j}})=>e.jsxs(g.Item,{children:[e.jsx(g.Control,{children:e.jsx(ne,{className:"bg-ui-bg-field-component hover:bg-ui-bg-field-component-hover",value:w,onChange:O=>{p({reason_id:O}),b(O)},...j,options:I.map(O=>({label:O.label,value:O.id}))})}),e.jsx(g.ErrorMessage,{})]})})}),e.jsx(te,{type:"button",className:"flex-shrink",variant:"transparent",onClick:()=>{l.setValue(`inbound_items.${x}.reason_id`,null),p({reason_id:null})},children:e.jsx(me,{className:"text-ui-fg-muted"})})]})]}),A&&e.jsxs("div",{className:"grid grid-cols-1 gap-2 p-3 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(g.Label,{children:S("orders.returns.note")}),e.jsx(g.Hint,{className:"!mt-1",children:S("orders.returns.noteHint")})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(g.Field,{control:l.control,name:`inbound_items.${x}.note`,render:({field:{ref:T,...w}})=>e.jsxs(g.Item,{children:[e.jsx(g.Control,{children:e.jsx(ce,{...w,onBlur:()=>{w.onChange(w.value),p({internal_note:w.value})},className:"bg-ui-bg-field-component hover:bg-ui-bg-field-component-hover"})}),e.jsx(g.ErrorMessage,{})]})})}),e.jsx(te,{type:"button",className:"flex-shrink",variant:"transparent",onClick:()=>{l.setValue(`inbound_items.${x}.note`,null),p({internal_note:null})},children:e.jsx(me,{className:"text-ui-fg-muted"})})]})]})]})]})}var ae=[],_e=[],Ct=({order:s,preview:r,exchange:o,form:l,orderReturn:a})=>{var k;const{t:p}=V(),{setIsOpen:x}=De(),[S,I]=v.useState({}),{mutateAsync:E}=at((k=r==null?void 0:r.order_change)==null?void 0:k.return_id,s.id),{mutateAsync:M}=Xe(o.id,s.id),{mutateAsync:A}=Qe(o.id,s.id),{mutateAsync:T}=Je(o.id,s.id),{mutateAsync:w}=Ke(o.id,s.id),{mutateAsync:b}=We(o.id,s.id),j=v.useMemo(()=>{var c;return(c=r==null?void 0:r.items)==null?void 0:c.filter(u=>{var t;return!!((t=u.actions)!=null&&t.find(i=>i.exchange_id===o.id))})},[r.items]),O=j.filter(c=>{var u;return!!((u=c.actions)!=null&&u.find(t=>t.action==="RETURN_ITEM"))}),C=v.useMemo(()=>{var c;return new Map((c=s==null?void 0:s.items)==null?void 0:c.map(u=>[u.id,u]))},[s.items]),H=l.watch("location_id"),{stock_locations:$=[]}=ht({limit:999}),{shipping_options:R=[]}=Te({limit:999,fields:"*prices,+service_zone.fulfillment_set.location.id",stock_location_id:H},{enabled:!!H}),F=R.filter(c=>!!c.rules.find(u=>u.attribute==="is_return"&&u.value==="true")),{fields:P,append:Q,remove:L,update:z}=Ee({name:"inbound_items",control:l.control}),B=v.useMemo(()=>new Map(j.map(c=>[c.id,c])),[j,P]);v.useEffect(()=>{const c={};O.forEach(u=>{var i,n;const t=P.findIndex(d=>d.item_id===u.id);if(c[u.id]=!0,t>-1){if(P[t].quantity!==u.detail.return_requested_quantity){const d=(i=u.actions)==null?void 0:i.find(y=>y.action==="RETURN_ITEM");z(t,{...P[t],quantity:u.detail.return_requested_quantity,note:d==null?void 0:d.internal_note,reason_id:(n=d==null?void 0:d.details)==null?void 0:n.reason_id})}}else Q({item_id:u.id,quantity:u.detail.return_requested_quantity},{shouldFocus:!1})}),P.forEach((u,t)=>{u.item_id in c||L(t)})},[j]),v.useEffect(()=>{const c=r.shipping_methods.find(u=>{var t;return(t=u.actions)==null?void 0:t.find(i=>i.action==="SHIPPING_ADD"&&!!i.return_id)});c?l.setValue("inbound_option_id",c.shipping_option_id):l.setValue("inbound_option_id","")},[r.shipping_methods]),v.useEffect(()=>{l.setValue("location_id",a==null?void 0:a.location_id)},[a]);const h=!P.length,f=async()=>{var c,u,t;ae.length&&await T({items:ae.map(i=>({id:i,quantity:1}))},{onError:i=>{D.error(i.message)}});for(const i of _e){const n=(t=(u=(c=j.find(d=>d.id===i))==null?void 0:c.actions)==null?void 0:u.find(d=>d.action==="RETURN_ITEM"))==null?void 0:t.id;n&&await b(n,{onError:d=>{D.error(d.message)}})}x("inbound-items",!1)},m=async c=>{await E({location_id:c})},_=async c=>{const t=r.shipping_methods.filter(i=>{var n;return(n=i.actions)==null?void 0:n.find(d=>d.action==="SHIPPING_ADD"&&!!d.return_id)}).filter(Boolean).map(i=>{var d;const n=(d=i.actions)==null?void 0:d.find(y=>y.action==="SHIPPING_ADD"&&!!y.return_id);if(n)return A(n.id)});await Promise.all(t),c&&await M({shipping_option_id:c},{onError:i=>{D.error(i.message)}})},N=v.useMemo(()=>H?!P.map(u=>{var i,n;const t=C.get(u.item_id);return!(t!=null&&t.variant_id)||!(t!=null&&t.variant)||!((i=t.variant)!=null&&i.manage_inventory)?!0:(n=S[t.variant_id])==null?void 0:n.find(d=>d.location_id===H)}).every(Boolean):!1,[P,S,H]);return v.useEffect(()=>{(async()=>{const u={};if(!P.length)return u;const t=P.map(n=>n==null?void 0:n.variant_id).filter(Boolean);return(await Ce.admin.productVariant.list({id:t,fields:"*inventory.location_levels"})).variants.forEach(n=>{var d,y;u[n.id]=((y=(d=n.inventory)==null?void 0:d[0])==null?void 0:y.location_levels)||[]}),u})().then(u=>{I(u)})},[P]),e.jsxs("div",{children:[e.jsxs("div",{className:"mt-8 flex items-center justify-between",children:[e.jsx(ue,{level:"h2",children:p("orders.returns.inbound")}),e.jsxs(U,{id:"inbound-items",children:[e.jsx(U.Trigger,{asChild:!0,children:e.jsx("a",{className:"focus-visible:shadow-borders-focus transition-fg txt-compact-small-plus cursor-pointer text-blue-500 outline-none hover:text-blue-400",children:p("actions.addItems")})}),e.jsxs(U.Content,{children:[e.jsx(U.Header,{}),e.jsx(Nt,{items:s.items,selectedItems:P.map(c=>c.item_id),currencyCode:s.currency_code,onSelectionChange:c=>{const u=P.map(t=>t.item_id);ae=c.filter(t=>!u.includes(t)),_e=u.filter(t=>!c.includes(t))}}),e.jsx(U.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(X.Close,{asChild:!0,children:e.jsx(W,{type:"button",variant:"secondary",size:"small",children:p("actions.cancel")})}),e.jsx(W,{type:"submit",variant:"primary",size:"small",role:"button",onClick:async()=>await f(),children:p("actions.save")},"submit-button")]})})})]})]})]}),h&&e.jsx(ve,{}),P.map((c,u)=>B.get(c.item_id)&&C.get(c.item_id)&&e.jsx(Et,{item:C.get(c.item_id),previewItem:B.get(c.item_id),currencyCode:s.currency_code,form:l,onRemove:()=>{var i,n,d;const t=(d=(n=(i=j.find(y=>y.id===c.item_id))==null?void 0:i.actions)==null?void 0:n.find(y=>y.action==="RETURN_ITEM"))==null?void 0:d.id;t&&b(t,{onError:y=>{D.error(y.message)}})},onUpdate:t=>{var n,d;const i=(d=(n=j.find(y=>y.id===c.item_id))==null?void 0:n.actions)==null?void 0:d.find(y=>y.action==="RETURN_ITEM");i&&w({...t,actionId:i.id},{onError:y=>{var Y,Z;(Y=i.details)!=null&&Y.quantity&&t.quantity&&l.setValue(`inbound_items.${u}.quantity`,(Z=i.details)==null?void 0:Z.quantity),D.error(y.message)}})},index:u},c.id)),!h&&e.jsxs("div",{className:"mt-8 flex flex-col gap-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(g.Label,{children:p("orders.returns.location")}),e.jsx(g.Hint,{className:"!mt-1",children:p("orders.returns.locationHint")})]}),e.jsx(g.Field,{control:l.control,name:"location_id",render:({field:{value:c,onChange:u,...t}})=>e.jsx(g.Item,{children:e.jsx(g.Control,{children:e.jsx(ne,{...t,value:c??void 0,onChange:i=>{u(i),m(i)},options:($??[]).map(i=>({label:i.name,value:i.id}))})})})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsxs(g.Label,{children:[p("orders.returns.inboundShipping"),e.jsxs(G,{size:"small",leading:"compact",className:"text-ui-fg-muted ml-1 inline",children:["(",p("fields.optional"),")"]})]}),e.jsx(g.Hint,{className:"!mt-1",children:p("orders.returns.inboundShippingHint")})]}),e.jsx(g.Field,{control:l.control,name:"inbound_option_id",render:({field:{value:c,onChange:u,...t}})=>e.jsx(g.Item,{children:e.jsx(g.Control,{children:e.jsx(ne,{allowClear:!0,value:c??void 0,onChange:i=>{u(i),_(i)},...t,options:F.map(i=>({label:i.name,value:i.id})),disabled:!H,noResultsPlaceholder:e.jsx(He,{})})})})})]})]}),N&&e.jsxs(qe,{variant:"warning",dismissible:!0,className:"mt-4 p-5",children:[e.jsx("div",{className:"text-ui-fg-subtle txt-small pb-2 font-medium leading-[20px]",children:p("orders.returns.noInventoryLevel")}),e.jsx(G,{className:"text-ui-fg-subtle txt-small leading-normal",children:p("orders.returns.noInventoryLevelDesc")})]})]})},ee=Oe(),Pt=s=>{const{t:r}=V();return v.useMemo(()=>[ee.display({id:"select",header:({table:o})=>e.jsx(se,{checked:o.getIsSomePageRowsSelected()?"indeterminate":o.getIsAllPageRowsSelected(),onCheckedChange:l=>o.toggleAllPageRowsSelected(!!l)}),cell:({row:o})=>{const l=o.getCanSelect();return e.jsx(se,{disabled:!l,checked:o.getIsSelected(),onCheckedChange:a=>o.toggleSelected(!!a),onClick:a=>{a.stopPropagation()}})}}),ee.display({id:"product",header:()=>e.jsx(Se,{}),cell:({row:o})=>e.jsx(Ne,{product:o.original.product})}),ee.accessor("sku",{header:r("fields.sku"),cell:({getValue:o})=>o()||"-"}),ee.accessor("title",{header:r("fields.title")})],[r,s])},Mt=()=>{const{t:s}=V();return[{key:"created_at",label:s("fields.createdAt"),type:"date"},{key:"updated_at",label:s("fields.updatedAt"),type:"date"}]},kt=({pageSize:s=50,prefix:r})=>{const o=we(["q","offset","order","created_at","updated_at"],r),{offset:l,created_at:a,updated_at:p,...x}=o;return{searchParams:{...x,limit:s,offset:l?Number(l):0,created_at:a?JSON.parse(a):void 0,updated_at:p?JSON.parse(p):void 0},raw:o}},oe=50,be="rit",At=({onSelectionChange:s,selectedItems:r,currencyCode:o})=>{const{t:l}=V(),[a,p]=v.useState(r.reduce((b,j)=>(b[j]=!0,b),{})),x=b=>{const j=typeof b=="function"?b(a):b;p(j),s(Object.keys(j))},{searchParams:S,raw:I}=kt({pageSize:oe,prefix:be}),{variants:E=[],count:M}=xt({...S,fields:"*inventory_items.inventory.location_levels,+inventory_quantity"}),A=Pt(o),T=Mt(),{table:w}=ke({data:E,columns:A,count:M,enablePagination:!0,getRowId:b=>b.id,pageSize:oe,enableRowSelection:b=>!0,rowSelection:{state:a,updater:x}});return e.jsx("div",{className:"flex size-full flex-col overflow-hidden",children:e.jsx(Ae,{table:w,columns:A,pageSize:oe,count:M,filters:T,pagination:!0,layout:"fill",search:!0,orderBy:[{key:"product_id",label:l("fields.product")},{key:"title",label:l("fields.title")},{key:"sku",label:l("fields.sku")}],prefix:be,queryObject:I})})};function wt({previewItem:s,currencyCode:r,form:o,onRemove:l,onUpdate:a,index:p}){const{t:x}=V();return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl ",children:e.jsxs("div",{className:"flex flex-col items-center gap-x-2 gap-y-2 p-3 text-sm md:flex-row",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(Pe,{src:s.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsxs(G,{className:"txt-small",as:"span",weight:"plus",children:[s.title," "]}),s.variant_sku&&e.jsxs("span",{children:["(",s.variant_sku,")"]})]}),e.jsx(G,{as:"div",className:"text-ui-fg-subtle txt-small",children:s.subtitle})]})]}),e.jsxs("div",{className:"flex flex-1 justify-between",children:[e.jsxs("div",{className:"flex flex-grow items-center gap-2",children:[e.jsx(g.Field,{control:o.control,name:`outbound_items.${p}.quantity`,render:({field:S})=>e.jsxs(g.Item,{children:[e.jsx(g.Control,{children:e.jsx(ce,{...S,className:"bg-ui-bg-base txt-small w-[67px] rounded-lg",min:1,type:"number",onBlur:I=>{const E=I.target.value,M=E===""?null:Number(E);S.onChange(M),M&&a({quantity:M})}})}),e.jsx(g.ErrorMessage,{})]})}),e.jsx(G,{className:"txt-small text-ui-fg-subtle",children:x("fields.qty")})]}),e.jsx("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-shrink-0",children:e.jsx(ye,{currencyCode:r,amount:s.total})}),e.jsx(Me,{groups:[{actions:[{label:x("actions.remove"),onClick:l,icon:e.jsx(Re,{})}].filter(Boolean)}]})]})]})})}var re=[],je=[],Dt=({order:s,preview:r,exchange:o,form:l})=>{const{t:a}=V(),{setIsOpen:p}=De(),[x,S]=v.useState({}),{shipping_options:I=[]}=Te({limit:999,fields:"*prices,+service_zone.fulfillment_set.location.id"}),E=I.filter(h=>!!h.rules.find(f=>f.attribute==="is_return"&&f.value==="false")),{mutateAsync:M}=Ye(o.id,s.id),{mutateAsync:A}=Ze(o.id,s.id),{mutateAsync:T}=et(o.id,s.id),{mutateAsync:w}=tt(o.id,s.id),{mutateAsync:b}=nt(o.id,s.id),j=v.useMemo(()=>{var h;return(h=r==null?void 0:r.items)==null?void 0:h.filter(f=>{var m;return!!((m=f.actions)!=null&&m.find(_=>_.exchange_id===o.id&&_.action==="ITEM_ADD"))})},[r.items]),O=v.useMemo(()=>{var h;return new Map((h=s==null?void 0:s.items)==null?void 0:h.map(f=>[f.variant_id,f]))},[s.items]),{fields:C,append:H,remove:$,update:R}=Ee({name:"outbound_items",control:l.control}),F=v.useMemo(()=>new Map(j.map(h=>[h.variant_id,h])),[j,C]);v.useEffect(()=>{const h={};j.forEach(f=>{const m=C.findIndex(_=>_.item_id===f.id);h[f.id]=!0,m>-1?C[m].quantity!==f.detail.quantity&&R(m,{...C[m],quantity:f.detail.quantity}):H({item_id:f.id,quantity:f.detail.quantity,variant_id:f.variant_id},{shouldFocus:!1})}),C.forEach((f,m)=>{f.item_id in h||$(m)})},[j]);const P=l.watch("location_id"),Q=!C.length,L=async()=>{var h,f;re.length&&await T({items:re.map(m=>({variant_id:m,quantity:1}))},{onError:m=>{D.error(m.message)}});for(const m of je){const _=(f=(h=j.find(N=>N.variant_id===m))==null?void 0:h.actions)==null?void 0:f.find(N=>N.action==="ITEM_ADD");_!=null&&_.id&&await b(_==null?void 0:_.id,{onError:N=>{D.error(N.message)}})}p("outbound-items",!1)};v.useEffect(()=>{const h=r.shipping_methods.find(f=>{var m;return!!((m=f.actions)!=null&&m.find(_=>_.action==="SHIPPING_ADD"&&!_.return_id))});h?l.setValue("outbound_option_id",h.shipping_option_id):l.setValue("outbound_option_id","")},[r.shipping_methods]);const z=async h=>{const m=r.shipping_methods.filter(_=>{var N;return!!((N=_.actions)!=null&&N.find(k=>k.action==="SHIPPING_ADD"&&!k.return_id))}).filter(Boolean).map(_=>{var k;const N=(k=_.actions)==null?void 0:k.find(c=>c.action==="SHIPPING_ADD"&&!c.return_id);if(N)return A(N.id)});await Promise.all(m),h&&await M({shipping_option_id:h},{onError:_=>{D.error(_.message)}})},B=v.useMemo(()=>P?!C.map(f=>{var _,N;const m=O.get(f.variant_id);return!(m!=null&&m.variant_id)||!(m!=null&&m.variant)||!((_=m.variant)!=null&&_.manage_inventory)?!0:(N=x[m.variant_id])==null?void 0:N.find(k=>k.location_id===P)}).every(Boolean):!1,[C,x,P]);return v.useEffect(()=>{(async()=>{const f={};if(!C.length)return f;const m=C.map(N=>N==null?void 0:N.variant_id).filter(Boolean);return(await Ce.admin.productVariant.list({id:m,fields:"*inventory.location_levels"})).variants.forEach(N=>{var k,c;f[N.id]=((c=(k=N.inventory)==null?void 0:k[0])==null?void 0:c.location_levels)||[]}),f})().then(f=>{S(f)})},[C]),e.jsxs("div",{children:[e.jsxs("div",{className:"mt-8 flex items-center justify-between",children:[e.jsx(ue,{level:"h2",children:a("orders.returns.outbound")}),e.jsxs(U,{id:"outbound-items",children:[e.jsx(U.Trigger,{asChild:!0,children:e.jsx("a",{className:"focus-visible:shadow-borders-focus transition-fg txt-compact-small-plus cursor-pointer text-blue-500 outline-none hover:text-blue-400",children:a("actions.addItems")})}),e.jsxs(U.Content,{children:[e.jsx(U.Header,{}),e.jsx(At,{selectedItems:C.map(h=>h.variant_id),currencyCode:s.currency_code,onSelectionChange:h=>{const f=C.map(m=>m.variant_id);re=h.filter(m=>!f.includes(m)),je=f.filter(m=>!h.includes(m))}}),e.jsx(U.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(X.Close,{asChild:!0,children:e.jsx(W,{type:"button",variant:"secondary",size:"small",children:a("actions.cancel")})}),e.jsx(W,{type:"submit",variant:"primary",size:"small",role:"button",onClick:async()=>await L(),children:a("actions.save")},"submit-button")]})})})]})]})]}),Q&&e.jsx(ve,{}),C.map((h,f)=>F.get(h.variant_id)&&e.jsx(wt,{previewItem:F.get(h.variant_id),currencyCode:s.currency_code,form:l,onRemove:()=>{var _,N,k;const m=(k=(N=(_=j.find(c=>c.id===h.item_id))==null?void 0:_.actions)==null?void 0:N.find(c=>c.action==="ITEM_ADD"))==null?void 0:k.id;m&&b(m,{onError:c=>{D.error(c.message)}})},onUpdate:m=>{var N,k,c;const _=(c=(k=(N=j.find(u=>u.id===h.item_id))==null?void 0:N.actions)==null?void 0:k.find(u=>u.action==="ITEM_ADD"))==null?void 0:c.id;_&&w({...m,actionId:_},{onError:u=>{D.error(u.message)}})},index:f},h.id)),!Q&&e.jsx("div",{className:"mt-8 flex flex-col gap-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx(g.Label,{children:a("orders.exchanges.outboundShipping")}),e.jsx(g.Hint,{className:"!mt-1",children:a("orders.exchanges.outboundShippingHint")})]}),e.jsx(g.Field,{control:l.control,name:"outbound_option_id",render:({field:{value:h,onChange:f,...m}})=>e.jsx(g.Item,{children:e.jsx(g.Control,{children:e.jsx(ne,{allowClear:!0,noResultsPlaceholder:e.jsx(Fe,{}),value:h??void 0,onChange:_=>{f(_),z(_)},...m,options:E.map(_=>({label:_.name,value:_.id})),disabled:!E.length})})})})]})}),B&&e.jsxs(qe,{variant:"warning",dismissible:!0,className:"mt-4 p-5",children:[e.jsx("div",{className:"text-ui-fg-subtle txt-small pb-2 font-medium leading-[20px]",children:a("orders.returns.noInventoryLevel")}),e.jsx(G,{className:"text-ui-fg-subtle txt-small leading-normal",children:a("orders.returns.noInventoryLevelDesc")})]})]})},le=!1,Tt=({order:s,preview:r,exchange:o,orderReturn:l})=>{const{t:a}=V(),{handleSuccess:p}=_t(),[x,S]=v.useState(!1),[I,E]=v.useState(!1),[M,A]=v.useState({value:"0",float:0}),[T,w]=v.useState({value:"0",float:0}),{mutateAsync:b,isPending:j}=Ve(o.id,s.id),{mutateAsync:O,isPending:C}=Ue(o.id,s.id),{mutateAsync:H,isPending:$}=Ge(o.id,s.id),{mutateAsync:R,isPending:F}=$e(o.id,s.id),P=j||C||F||$,Q=v.useMemo(()=>{var t;return(t=r==null?void 0:r.items)==null?void 0:t.filter(i=>{var n;return!!((n=i.actions)!=null&&n.find(d=>d.exchange_id===o.id))})},[r.items]),L=Q.filter(t=>{var i;return!!((i=t.actions)!=null&&i.find(n=>n.action==="RETURN_ITEM"))}),z=Q.filter(t=>{var i;return!!((i=t.actions)!=null&&i.find(n=>n.action==="ITEM_ADD"))}),B=ut({defaultValues:()=>{const t=r.shipping_methods.find(n=>{var d;return!!((d=n.actions)!=null&&d.find(y=>y.action==="SHIPPING_ADD"&&!!y.return_id))}),i=r.shipping_methods.find(n=>{var d;return!!((d=n.actions)!=null&&d.find(y=>y.action==="SHIPPING_ADD"&&!y.return_id))});return Promise.resolve({inbound_items:L.map(n=>{var y,Y;const d=(y=n.actions)==null?void 0:y.find(Z=>Z.action==="RETURN_ITEM");return{item_id:n.id,variant_id:n.variant_id,quantity:n.detail.return_requested_quantity,note:d==null?void 0:d.internal_note,reason_id:(Y=d==null?void 0:d.details)==null?void 0:Y.reason_id}}),outbound_items:z.map(n=>({item_id:n.id,variant_id:n.variant_id,quantity:n.detail.quantity})),inbound_option_id:t?t.shipping_option_id:"",outbound_option_id:i?i.shipping_option_id:"",location_id:l==null?void 0:l.location_id,send_notification:!1})},resolver:pt(jt)}),h=r.shipping_methods.find(t=>{var i;return!!((i=t.actions)!=null&&i.find(n=>n.action==="SHIPPING_ADD"&&!!n.return_id))}),f=r.shipping_methods.find(t=>{var i;return!!((i=t.actions)!=null&&i.find(n=>n.action==="SHIPPING_ADD"&&!n.return_id))});v.useEffect(()=>{h&&A(h.total)},[h]),v.useEffect(()=>{f&&w(f.total)},[f]);const m=B.watch("inbound_option_id"),_=B.watch("outbound_option_id"),N=bt(),k=B.handleSubmit(async t=>{try{if(!await N({title:a("general.areYouSure"),description:a("orders.exchanges.confirmText"),confirmText:a("actions.continue"),cancelText:a("actions.cancel"),variant:"confirmation"}))return;await b({no_notification:!t.send_notification}),p()}catch(i){D.error(a("general.error"),{description:i.message})}});v.useEffect(()=>{var t;x&&((t=document.getElementById("js-inbound-shipping-input"))==null||t.focus())},[x]),v.useEffect(()=>{var t;I&&((t=document.getElementById("js-outbound-shipping-input"))==null||t.focus())},[I]),v.useEffect(()=>()=>{le&&(O(void 0,{onSuccess:()=>{D.success(a("orders.exchanges.actions.cancelExchange.successToast"))},onError:t=>{D.error(t.message)}}),le=!1)},[]);const c=v.useMemo(()=>{const t=r.shipping_methods.find(i=>{var n;return!!((n=i.actions)!=null&&n.find(d=>d.action==="SHIPPING_ADD"&&!!d.return_id))});return(t==null?void 0:t.total)||0},[r.shipping_methods]),u=v.useMemo(()=>{const t=r.shipping_methods.find(i=>{var n;return!!((n=i.actions)!=null&&n.find(d=>d.action==="SHIPPING_ADD"&&!d.return_id))});return(t==null?void 0:t.total)||0},[r.shipping_methods]);return e.jsx(X.Form,{form:B,children:e.jsxs(gt,{onSubmit:k,className:"flex h-full flex-col",children:[e.jsx(X.Header,{}),e.jsx(X.Body,{className:"flex size-full justify-center overflow-y-auto",children:e.jsxs("div",{className:"mt-16 w-[720px] max-w-[100%] px-4 md:p-0",children:[e.jsx(ue,{level:"h1",children:a("orders.exchanges.create")}),e.jsx(Ct,{form:B,preview:r,order:s,exchange:o,orderReturn:l}),e.jsx(Dt,{form:B,preview:r,order:s,exchange:o}),e.jsxs("div",{className:"mt-8 border-y border-dotted py-4",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:a("orders.returns.inboundTotal")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:K(L.reduce((t,i)=>{var d;const n=(d=i.actions)==null?void 0:d.find(y=>y.action==="RETURN_ITEM");return t=t+((n==null?void 0:n.amount)||0),t},0)*-1,s.currency_code)})]}),e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:a("orders.exchanges.outboundTotal")}),e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:K(z.reduce((t,i)=>{var d;const n=(d=i.actions)==null?void 0:d.find(y=>y.action==="ITEM_ADD");return t=t+((n==null?void 0:n.amount)||0),t},0),s.currency_code)})]}),e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:a("orders.returns.inboundShipping")}),e.jsxs("span",{className:"txt-small text-ui-fg-subtle flex items-center",children:[!x&&e.jsx(te,{onClick:()=>S(!0),variant:"transparent",className:"text-ui-fg-muted",disabled:!(L!=null&&L.length)||!m,children:e.jsx(he,{})}),x?e.jsx(fe,{id:"js-inbound-shipping-input",onBlur:()=>{let t;r.shipping_methods.forEach(n=>{if(n.actions)for(const d of n.actions)d.action==="SHIPPING_ADD"&&d.return_id&&(t=d.id)});const i=M.float;t&&H({actionId:t,custom_amount:i},{onError:n=>{D.error(n.message)}}),S(!1)},symbol:pe[s.currency_code.toUpperCase()].symbol_native,code:s.currency_code,onValueChange:(t,i,n)=>A({value:(n==null?void 0:n.value)||"",float:(n==null?void 0:n.float)||null}),value:M.value,disabled:!(L!=null&&L.length)}):K(c,s.currency_code)]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"txt-small text-ui-fg-subtle",children:a("orders.exchanges.outboundShipping")}),e.jsxs("span",{className:"txt-small text-ui-fg-subtle flex items-center",children:[!I&&e.jsx(te,{onClick:()=>E(!0),variant:"transparent",className:"text-ui-fg-muted",disabled:!(z!=null&&z.length)||!_,children:e.jsx(he,{})}),I?e.jsx(fe,{id:"js-outbound-shipping-input",onBlur:()=>{let t;r.shipping_methods.forEach(n=>{if(n.actions)for(const d of n.actions)d.action==="SHIPPING_ADD"&&!d.return_id&&(t=d.id)});const i=T.float;t&&R({actionId:t,custom_amount:i},{onError:n=>{D.error(n.message)}}),E(!1)},symbol:pe[s.currency_code.toUpperCase()].symbol_native,code:s.currency_code,onValueChange:(t,i,n)=>w({value:(n==null?void 0:n.value)||"",float:(n==null?void 0:n.float)||null}),value:T.value,disabled:!(z!=null&&z.length)}):K(u,s.currency_code)]})]}),e.jsxs("div",{className:"mt-4 flex items-center justify-between border-t border-dotted pt-4",children:[e.jsx("span",{className:"txt-small font-medium",children:a("orders.exchanges.refundAmount")}),e.jsx("span",{className:"txt-small font-medium",children:K(r.summary.pending_difference,s.currency_code)})]})]}),e.jsx("div",{className:"bg-ui-bg-field mt-8 rounded-lg border py-2 pl-2 pr-4",children:e.jsx(g.Field,{control:B.control,name:"send_notification",render:({field:{onChange:t,value:i,...n}})=>e.jsxs(g.Item,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(g.Control,{className:"mr-4 self-start",children:e.jsx(mt,{className:"mt-[2px]",checked:!!i,onCheckedChange:t,...n})}),e.jsxs("div",{className:"block",children:[e.jsx(g.Label,{children:a("orders.returns.sendNotification")}),e.jsx(g.Hint,{className:"!mt-1",children:a("orders.returns.sendNotificationHint")})]})]}),e.jsx(g.ErrorMessage,{})]})})}),e.jsx("div",{className:"p-8"})]})}),e.jsx(X.Footer,{children:e.jsx("div",{className:"flex w-full items-center justify-end gap-x-4",children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(X.Close,{asChild:!0,children:e.jsx(W,{type:"button",onClick:()=>le=!0,variant:"secondary",size:"small",children:a("orders.exchanges.cancel.title")})}),e.jsx(W,{type:"submit",variant:"primary",size:"small",isLoading:P,children:a("orders.exchanges.confirm")},"submit-button")]})})})]})})},de=!1,Mn=()=>{const{id:s}=rt(),r=lt(),{t:o}=V(),{order:l}=dt(s,{fields:ot}),{order:a}=ct(s),[p,x]=v.useState(),{mutateAsync:S}=ze(l.id),{exchange:I}=Be(p,void 0,{enabled:!!p}),{return:E}=it(I==null?void 0:I.return_id,void 0,{enabled:!!(I!=null&&I.return_id)});return v.useEffect(()=>{async function M(){if(!(de||!a)){if(a.order_change){a.order_change.change_type==="exchange"?x(a.order_change.exchange_id):(r(`/orders/${a.id}`,{replace:!0}),D.error(o("orders.exchanges.activeChangeError")));return}de=!0;try{const{exchange:A}=await S({order_id:a.id});x(A.id)}catch(A){D.error(A.message),r(`/orders/${a.id}`,{replace:!0})}finally{de=!1}}}M()},[a]),e.jsx(X,{children:I&&a&&l&&e.jsx(Tt,{order:l,exchange:I,preview:a,orderReturn:E})})};export{Mn as Component};
